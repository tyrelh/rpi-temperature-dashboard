import React, {ReactElement, useEffect, useState} from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';
import { URLSearchParams } from 'url';
import TemperaturePreview from '../components/TemperaturePreview';
import { Temperature } from '../DTOS/Temperature';
import { getISODateStringFromDate, subtractDaysFromDate } from '../utils/DateUtils';
import { TEMPERATURE_API_URL as API_BASE_URL } from '../config';
import { Col, Row } from 'antd';
import { buildQueryParams } from '../utils/UrlUtils';

const TEMPERATURE_ENDPOINT = "/temperature";
const TEMPERATURES_ENDPOINT = "/temperatures";
const LOCATIONS_ENDPOINT = "/locations";
const NUMBER_OF_COLUMNS = 2;

function generateDummyData() {
  return ["sun-room", "office"];
}

const Home: NextPage = (props) => {
  const [latestTemperatureData, setLatestTemperatureData] = useState<Temperature[]>([]);
  const [fullTemperatureData, setFullTemperatureData] = useState<Map<string, Temperature[]>>(new Map<string, Temperature[]>())
  const [dataFetched, setDataFetched] = useState<boolean>(false);


  async function fetchLocations(date: Date): Promise<string[]> {
    let locations: string[] = []
      try {
        const params = new Map<string, string>()
          .set("date", getISODateStringFromDate(date));
        const locationsResponse = await fetch(API_BASE_URL + LOCATIONS_ENDPOINT + buildQueryParams(params));
        const locationsResponseBody = await locationsResponse.json()
        // console.log("Locations response body: ", locationsResponseBody);
        locations = locations.concat(locationsResponseBody.locations);
      } catch (e) {
        console.error("No locations were found: ", e);
      }
      // console.log(locations);
      return locations;
  }


  async function fetchLatestTemperatures(date: Date, locations: string[]): Promise<void> {
    const data: Temperature[] = [...latestTemperatureData];
    for (let location of locations) {
      const params = new Map<string, string>()
        .set("location", location)
        .set("date", getISODateStringFromDate(date));
      const url = API_BASE_URL + TEMPERATURE_ENDPOINT + buildQueryParams(params);
      // console.log(url)
      const response = await fetch(url)
      // console.log("Raw response: ", response);
      const body = await response.json();
      if (!body) {
        console.log("No results returned from api")
        continue;
      }
      console.log(body)
      let existing: Temperature | undefined;
      if (existing = data.find((t: Temperature) =>  t.location == location )) {
        // console.log(existing)
        existing.value = body.value;
        existing.time = body.time;
      } else {
        data.push({
          location: location,
          value: body.value,
          time: new Date(body.time)
        });
      }
    }
    setLatestTemperatureData(data);
  }


  async function fetchFullTemperatures(startDate: Date, endDate: Date, locations: string[]): Promise<void> {
    const startDateString = getISODateStringFromDate(startDate);
    const endDateString = getISODateStringFromDate(endDate);
    for (let location of locations) {
      const params = new Map<string, string>()
        .set("location", location)
        .set("startDate", startDateString)
        .set("endDate", endDateString)
      const url = API_BASE_URL + TEMPERATURES_ENDPOINT + buildQueryParams(params);
      const response = await fetch(url);
      const body = await response.json();
      console.log("fetchFullTemperatures response body: ", body);
      if (!body) {
        console.log("No results returned from api")
        continue;
      }
      setFullTemperatureData(fullTemperatureData.set(location, body));
    }

    console.log("fullTemperatureData:", fullTemperatureData);

  }


  useEffect(() => {
    async function getData() {
      setDataFetched(true)
      const now = new Date();
      const locations = await fetchLocations(now);
      if (locations.length > 0) {
        await fetchLatestTemperatures(now, locations);
        await fetchFullTemperatures(subtractDaysFromDate(now, 1), now, locations)
      }
    }
    if (!dataFetched) {
      getData();
    }
  }, []);


  function mapPreviewColumns(list: Array<Temperature>): ReactElement {
    let elements: ReactElement[] = [];
    list.map((value, index) => {
      elements.push(
        <Col span={12}>
          <TemperaturePreview latestTemperature={value}/>
        </Col>
      );
    })
    return <>{ elements }</>
  }


  function renderTemperatureGrid(data: Array<any>) {
    let elements: ReactElement[] = []
    let n = 0;
    while(n < data.length) {
      elements.push(
        <Row>
          { mapPreviewColumns(data.slice(n, n + NUMBER_OF_COLUMNS)) }
        </Row>
      )
      n += NUMBER_OF_COLUMNS;
    }
    return <>{ elements }</>
  }


  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {
        latestTemperatureData.length == 0 &&
        "No data for today yet..."
      }
      {
        latestTemperatureData.length != 0 &&
        renderTemperatureGrid(latestTemperatureData)
      }
    </>
  )
}

export default Home


// export const getServerSideProps: GetServerSideProps = async (context) => {
//   const date = new Date();

//   var params = {
//     location: 'office',
//     date: date.getTime().toString()
//   };

//   // console.log("Request params: ", params);
//   const esc = encodeURIComponent;
//   const query = Object.keys(params).map(k => esc(k) + '=' + esc(params[k])).join('&');
//   const url = API_URL + TEMPERATURE_ENDPOINT + "?" + query;
//   // console.log(url)
//   const response = await fetch(url)
//   // console.log("Raw response: ", response);
//   const body = await response.json();
//   if (!body) {
//     console.log("No results returned from api")
//     return {
//       props: {}
//     }
//   }
//   console.log(body)

//   return {
//     props: body
//   }
// }
